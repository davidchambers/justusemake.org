<html>
<head>
  <meta charset="utf-8">
  <title>Just Use Make</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="prose">
    <h1>Just Use Make</h1>
    <p>
      <a href="http://en.wikipedia.org/wiki/Make_(software)">Make</a> isn’t
      just for neckbeards who’ve been programming C since the seventies.
      Make is a popular, conceptually simple build tool for men and women
      of all ages.
    </p>
    <p>
      Make is finicky. Make is unapproachable. Make doesn’t run on Windows
      (without assistance).
    </p>
    <p>
      Make isn’t perfect. Many years of development effort have been spent
      creating Make-like tools which aim to be better than Make in general,
      or better than Make for a particular purpose.
    </p>
    <p>
      Often, though, one should <strong>just use Make</strong>.
    </p>
    <p>
      Let’s automate the build workflow for a hypothetical web application
      which uses CoffeeScript and Stylus. We’ll do this with both Make and
      <a href="http://gruntjs.com/">Grunt</a>, a popular JavaScript task
      runner.
    </p>
    <p>
      Let’s start with the simplest task a build tool must support: copying
      files. We wish to copy everything in the <b>src/assets</b> directory
      into <b>dist/assets</b>.
    </p>
  </div>
  <pre><code class="language-make">ASSETS = <span class="group">$(<span class="function">patsubst</span> src/%,dist/%,<span class="group">$(<span class="function">shell</span> find src/assets -type f | sort)</span>)</span>


<span class="targets"><span class="target special">.PHONY</span>:</span> build
<span class="targets"><span class="target">build</span>:</span> <span class="group">$(ASSETS)</span>

<span class="targets"><span class="target">dist/assets/%</span>:</span> src/assets/%
<span class="recipe">	<span class="silent">@</span>mkdir -p <span class="string">'<span class="auto-var" data-content="$(@D)">$(@D)</span>'</span>
	cp <span class="string">'<span class="auto-var" data-content="$&lt;">$&lt;</span>'</span> <span class="string">'<span class="auto-var" data-content="$@">$@</span>'</span></span>
</code></pre>
  <div class="prose">
    <p>
      In Make, the first step is to generate a list of files to build.
      In this case, we use the <code>find</code> command to make a list of
      <em>input</em> files by finding all the files in <b>src/assets</b>.
      We then use Make’s
      <a href="https://www.gnu.org/software/make/manual/html_node/Text-Functions.html"><code>patsubstr</code></a>
      to create a list of <em>output</em> files, which we name
      <code>ASSETS</code>. We then create a “target” named <code>build</code>
      and list all the assets as dependencies. This means running
      <code>make build</code> will build all the files in <code>ASSETS</code>.
      Let’s assume that <code>ASSETS</code> is <b>dist/assets/bar.png
      dist/assets/foo.png</b>. In order to build <b>dist/assets/bar.png</b>,
      Make looks for the first rule with a matching pattern. In this case,
      the <code>dist/assets/%</code> target describes how to build
      <b>dist/assets/bar.png</b> from <b>src/assets/bar.png</b>.
    </p>
    <p>
      Grunt requires a bit of set-up. First, install Grunt itself:
    </p>
  </div>
  <pre><code class="language-console"><span class="prompt">$</span> <span class="command">npm install -g grunt-cli</span>
</code></pre>
  <div class="prose">
    <p>
      To copy files, we’ll need the
      <a href="https://github.com/gruntjs/grunt-contrib-copy">grunt-contrib-copy</a>
      plugin:
    </p>
  </div>
  <pre><code class="language-console"><span class="prompt">$</span> <span class="command">npm install grunt-contrib-copy</span>
</code></pre>
  <div class="prose">
    <p>
      Next, we create a file named <b>Gruntfile.js</b> with some configuration
      to tell Grunt which files we want to copy and to where:
    </p>
  </div>
  <pre><code class="language-javascript">module.exports = <span class="keyword">function</span>(grunt) {

  grunt.initConfig({
    copy: {
      main: {
        expand: <span class="special-value">true</span>,
        cwd: <span class="string">'src/assets/'</span>,
        src: <span class="string">'**'</span>,
        dest: <span class="string">'dist/assets/'</span>,
        flatten: <span class="special-value">true</span>,
        filter: <span class="string">'isFile'</span>,
      },
    },
  });

  grunt.loadNpmTasks(<span class="string">'grunt-contrib-copy'</span>);

  grunt.registerTask(<span class="string">'default'</span>, [<span class="string">'copy'</span>]);

};
</code></pre>
  <div class="prose">
    <p>
      This is a <em>lot</em> of configuration for a straightforward task.
      What’s more, Grunt is about as smart as its name suggests:
    </p>
  </div>
  <pre><code class="language-console"><span class="prompt">$</span> <span class="command">grunt</span>
<span class="output">Running "copy:main" (copy) task
Copied 3 files

Done, without errors.
</span>
<span class="prompt">$</span> <span class="command">grunt</span>
<span class="output">Running "copy:main" (copy) task
Copied 3 files

Done, without errors.
</span></code></pre>
  <div class="prose">
    <p>
      Grunt goes ahead and copies the files each time. Make, thanks to the
      dependency graph we specified in the makefile, only rebuilds a file
      if one or more of its dependencies has changed:
    </p>
  </div>
  <pre><code class="language-console"><span class="prompt">$</span> <span class="command">make</span>
<span class="output">cp 'src/assets/images/bar.png' 'dist/assets/images/bar.png'
cp 'src/assets/images/baz.png' 'dist/assets/images/baz.png'
cp 'src/assets/images/foo.png' 'dist/assets/images/foo.png'
</span>
<span class="prompt">$</span> <span class="command">make</span>
<span class="output">make: Nothing to be done for `build'.
</span></code></pre>
  <div class="prose">
    <p>
      Right now our build step involves copying three images, but as our
      projects grows, rebuilding everything from scratch every time could
      disrupt our feedback loop. We don’t want to wait ten seconds to test
      every tweak we make to our app!
    </p>
    <p>
      The next thing we’d like to do is create JavaScript files from our
      CoffeeScript source files. First, with Make:
    </p>
  </div>
  <pre>...</pre>
  <pre><code class="language-make"></code></pre>
  <div class="prose">
    <p>Grunt example goes here.</p>
  </div>
  <pre><code class="language-make">COFFEE = node_modules/.bin/coffee
DOCTEST = node_modules/.bin/doctest --module commonjs
XYZ = node_modules/.bin/xyz --message X.Y.Z --tag X.Y.Z --repo git@github.com:davidchambers/orthogonal.git --script scripts/prepublish

SRC_IMAGES = <span class="group">$(<span class="function">shell</span> find src/svg -type f)</span>
SVG_IMAGES = <span class="group">$(<span class="function">patsubst</span> src/svg/%.coffee,lib/svg/%.svg,<span class="group">$(SRC_IMAGES)</span>)</span>
LIB = lib/orthogonal.js <span class="group">$(SVG_IMAGES)</span>

HAI = hello


<span class="targets"><span class="target special">.PHONY</span>:</span> all
<span class="targets"><span class="target">all</span>:</span> <span class="group">$(LIB)</span>

<span class="targets"><span class="target special">.PHONY</span>:</span> foo
<span class="targets"><span class="target">foo</span>:</span>
<span class="recipe">	echo <span class="string">'<span class="group">$(<span class="function">shell</span> echo <span class="string">'<span class="group">${HAI}</span>'</span>)</span>'</span></span>

<span class="targets"><span class="target">lib/%.js</span>:</span> src/%.coffee
<span class="recipe">	<span class="group">$(COFFEE)</span> --compile --output <span class="string">'<span class="auto-var" data-content="$(@D)">$(@D)</span>'</span> -- <span class="string">'<span class="auto-var" data-content="$&lt;">$&lt;</span>'</span>
	<span class="string">'<span class="group">${Foo}</span> $$BAR'</span> <span class="string">"<span class="group">$(Foo)</span> $$BAR"</span></span>

<span class="comment"># Percent 2 F : %2F</span>
<span class="targets"><span class="target">lib/%.svg</span>:</span> src/%.coffee
<span class="recipe">	mkdir -p <span class="string">'<span class="auto-var" data-content="$(@D)">$(@D)</span>'</span>
	<span class="comment"># comment</span>
	hello &lt; world
	echo <span class="string">'foo\
# not a comment\
bar'</span>
	<span class="group">$(COFFEE)</span> <span class="string">'<span class="auto-var" data-content="$&lt;">$&lt;</span>'</span> &gt;<span class="string">'<span class="auto-var" data-content="$@">$@</span>'</span></span>


<span class="targets"><span class="target special">.PHONY</span>:</span> clean
<span class="targets"><span class="target">clean</span>:</span>
<span class="recipe">	rm -f -- <span class="group">$(LIB)</span></span>


<span class="targets"><span class="target special">.PHONY</span>:</span> release-major release-minor release-patch
<span class="targets"><span class="target">release-major</span>:</span> LEVEL = major
<span class="targets"><span class="target">release-minor</span>:</span> LEVEL = minor
<span class="targets"><span class="target">release-patch</span>:</span> LEVEL = patch

<span class="targets"><span class="target">release-major</span> <span class="target">release-minor</span> <span class="target">release-patch</span>:</span>
<span class="recipe">	<span class="silent">@</span><span class="group">$(XYZ)</span> --increment <span class="group">$(LEVEL)</span></span>


<span class="targets"><span class="target special">.PHONY</span>:</span> setup
<span class="targets"><span class="target">setup</span>:</span>
<span class="recipe">	npm install
	make clean
	git update-index --assume-unchanged lib/orthogonal.js</span>


<span class="targets"><span class="target special">.PHONY</span>:</span> test
<span class="targets"><span class="target">test</span>:</span>
<span class="recipe">	find src -name <span class="string">'*.coffee'</span> -not -path <span class="string">'src/svg/*'</span> -print0 | xargs -0 <span class="group">$(DOCTEST)</span></span>
</code></pre>
</body>
</html>
